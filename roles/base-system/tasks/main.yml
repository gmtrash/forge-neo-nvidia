---
# Base system packages and configuration

- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600
  tags: base

- name: Upgrade all packages
  apt:
    upgrade: dist
    autoremove: yes
    autoclean: yes
  when: upgrade_system | default(false)
  tags: base

- name: Install essential packages
  apt:
    name:
      - apt-transport-https
      - ca-certificates
      - gnupg
      - lsb-release
      - software-properties-common
    state: present
  tags: base

- name: Install build tools
  apt:
    name:
      - build-essential
      - cmake
      - ninja-build
      - gcc
      - g++
      - make
      - pkg-config
    state: present
  when: install_build_tools | default(true)
  tags: base

- name: Install Python development packages
  apt:
    name:
      - python3-dev
      - python3-pip
      - python3-venv
      - python3-setuptools
    state: present
  when: install_dev_packages | default(true)
  tags: base

- name: Install additional packages
  apt:
    name: "{{ additional_apt_packages }}"
    state: present
  when: additional_apt_packages is defined
  tags: base

- name: Ensure user is in video and render groups (for GPU access)
  user:
    name: "{{ username }}"
    groups: video,render
    append: yes
  tags: base

- name: Create common directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ username }}"
    group: "{{ user_group }}"
    mode: '0755'
  loop:
    - "{{ home_dir }}/llm"
    - "{{ home_dir }}/bin"
    - "{{ backup_dir | default(home_dir + '/ansible-backups') }}"
  tags: base
